var S=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var M=(p,r)=>{for(var t in r)S(p,t,{get:r[t],enumerable:!0})},I=(p,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of V(r))!R.call(p,s)&&s!==t&&S(p,s,{get:()=>r[s],enumerable:!(e=O(r,s))||e.enumerable});return p};var N=p=>I(S({},"__esModule",{value:!0}),p);var J={};M(J,{default:()=>A});module.exports=N(J);var l=require("obsidian"),$={apiKey:"",model:"gpt-5.1",storageFolder:".flashcards"},C=1,x=1,m=1,D={yellow:"#ffe066",green:"#b2f2bb",blue:"#a5d8ff",flashcard:"#ffb3c1"},F="study-assist-flashcards-view",P="study-assist-flashcards-manage",E=class extends l.ItemView{constructor(t,e){super(t);this.cards=[];this.index=0;this.showingAnswer=!1;this.progress={};this.plugin=e}getViewType(){return F}getDisplayText(){return"Flashcards"}async onOpen(){this.containerEl.empty(),this.containerEl.addClass("study-assist-flashcard-view"),await this.reload(),this.render()}async reload(){this.cards=await this.plugin.loadAllCards(),this.progress=await this.plugin.loadProgress(),this.index=0,this.showingAnswer=!1}async refresh(){await this.reload(),this.render()}async onClose(){this.containerEl.empty()}currentCard(){let t=this.remainingCards();return t.length===0?null:t[this.index%t.length]}async handleGrade(t){let e=this.currentCard();if(!e)return;await this.plugin.updateProgressOptimistic(e.id,t),this.progress=await this.plugin.loadProgress();let s=this.remainingCards();s.length>0?this.index=(this.index+1)%s.length:this.index=0,this.showingAnswer=!1,this.render()}remainingCards(){return this.cards.filter(t=>{var e;return!((e=this.progress[t.id])!=null&&e.done)})}render(){this.containerEl.empty();let t=this.currentCard(),e=this.containerEl.createDiv({cls:"study-assist-flashcard-card"}),s=this.containerEl.createDiv({cls:"study-assist-flashcard-controls"}),a=this.containerEl.createDiv({cls:"study-assist-flashcard-meta"});if(!t){if(this.cards.length===0){e.setText("No flashcards yet. Generate some from PDF highlights.");return}e.setText("Congrats! You finished all flashcards."),s.empty(),s.createEl("button",{text:"Restart"}).addEventListener("click",async()=>{await this.plugin.resetProgress(),await this.reload(),this.render()});return}e.setText(this.showingAnswer?t.answer:t.question),e.addEventListener("click",()=>{this.showingAnswer=!this.showingAnswer,this.render()});let i=s.createEl("button",{text:"Again"}),h=s.createEl("button",{text:"Good"});i.addEventListener("click",()=>void this.handleGrade(!1)),h.addEventListener("click",()=>void this.handleGrade(!0));let n=this.remainingCards().length;a.setText(`Remaining ${n} of ${this.cards.length}`)}},T=class extends l.ItemView{constructor(t,e){super(t);this.cards=[];this.plugin=e}getViewType(){return P}getDisplayText(){return"Flashcards Manager"}async onOpen(){this.containerEl.empty(),this.containerEl.addClass("study-assist-flashcard-manage"),await this.reload(),this.render()}async onClose(){this.containerEl.empty()}async reload(){this.cards=await this.plugin.loadAllCards()}async refresh(){await this.reload(),this.render()}render(){this.containerEl.empty(),this.containerEl.createDiv({cls:"study-assist-manage-header"}).createEl("h3",{text:"Flashcards"});let e=this.containerEl.createDiv({cls:"study-assist-manage-add"}),s=e.createEl("textarea");s.placeholder="Question";let a=e.createEl("textarea");a.placeholder="Answer",e.createEl("button",{text:"Add"}).addEventListener("click",async()=>{let n=s.value.trim(),o=a.value.trim();if(!n||!o)return;let c=new Date().toISOString(),g={id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,sourcePath:"manual",highlightIds:[],question:n,answer:o,createdAt:c};this.cards.unshift(g),await this.plugin.replaceAllCards(this.cards),s.value="",a.value="",this.render()});let h=this.containerEl.createDiv({cls:"study-assist-manage-list"});if(this.cards.length===0){h.setText("No flashcards yet.");return}this.cards.forEach((n,o)=>{let c=h.createDiv({cls:"study-assist-manage-row"}),g=c.createEl("textarea");g.value=n.question;let d=c.createEl("textarea");d.value=n.answer;let f=c.createDiv({cls:"study-assist-manage-actions"}),u=f.createEl("button",{text:"Save"}),w=f.createEl("button",{text:"Delete"});u.addEventListener("click",async()=>{let v=g.value.trim(),y=d.value.trim();!v||!y||(this.cards[o]={...n,question:v,answer:y},await this.plugin.replaceAllCards(this.cards))}),w.addEventListener("click",async()=>{this.cards.splice(o,1),await this.plugin.replaceAllCards(this.cards),await this.plugin.removeProgress(n.id),this.render()})})}},H=class{constructor(r,t){this.selectionHandlerAttached=!1;this.plugin=r,this.leaf=t}async init(){await this.ensureAttached()}destroy(){var r,t;(r=this.toolbar)==null||r.remove(),(t=this.observer)==null||t.disconnect(),this.retryTimer&&window.clearTimeout(this.retryTimer)}async ensureAttached(r=5){let t=this.leaf.view.containerEl;if(!t)return;(!this.toolbar||!t.contains(this.toolbar))&&(this.toolbar=t.createDiv({cls:"study-assist-pdf-toolbar"}),this.buildToolbar(this.toolbar));let e=this.findPdfViewer();if(!e){r>0&&(this.retryTimer=window.setTimeout(()=>{this.ensureAttached(r-1)},250));return}this.selectionHandlerAttached||(t.addEventListener("mouseup",s=>{let a=window.getSelection();!a||a.isCollapsed||a.anchorNode&&t.contains(a.anchorNode)&&s.preventDefault()}),this.selectionHandlerAttached=!0),this.observer&&this.attachedPdfViewer!==e&&(this.observer.disconnect(),this.observer=void 0,this.attachedPdfViewer=void 0),this.observer||(this.observer=new MutationObserver(()=>{this.scheduleRenderHighlights()}),this.observer.observe(e,{childList:!0,subtree:!0}),this.attachedPdfViewer=e),this.scheduleRenderHighlights()}buildToolbar(r){[{color:"yellow",label:"Yellow"},{color:"green",label:"Green"},{color:"blue",label:"Blue"},{color:"flashcard",label:"Flashcard"}].forEach(({color:e,label:s})=>{let a=r.createEl("button"),i=a.createSpan({cls:"study-assist-color-swatch"});i.style.background=D[e],a.createSpan({text:s}),a.addEventListener("click",async()=>{let h=window.getSelection();if(!h||h.isCollapsed){new l.Notice("Select text in the PDF first.");return}let n=this.findPdfViewer();if(!n){new l.Notice("PDF viewer not found.");return}let o=this.buildHighlightFromSelection(h,n,e);if(!o){new l.Notice("Could not capture selection.");return}let c=this.getPdfFile();if(!c){new l.Notice("No PDF file associated with this view.");return}await this.plugin.saveHighlight(c.path,o),h.removeAllRanges(),await this.renderHighlights()})})}findPdfViewer(){let r=this.leaf.view.containerEl;return r?r.querySelector(".pdf-viewer")||r.querySelector(".pdfViewer")||r.querySelector(".pdf-viewer-container"):null}getPdfFile(){var t,e,s;let r=this.leaf.view;return(r==null?void 0:r.file)instanceof l.TFile?r.file:(s=(e=(t=this.leaf)==null?void 0:t.view)==null?void 0:e.file)!=null?s:null}buildHighlightFromSelection(r,t,e){if(r.rangeCount===0)return null;let s=r.getRangeAt(0),a=Array.from(s.getClientRects()).filter(o=>o.width>1&&o.height>1);if(a.length===0)return null;let i=Array.from(t.querySelectorAll(".page"));if(i.length===0)return null;let h=new Map;if(a.forEach(o=>{var v,y;let c=o.left+o.width/2,g=o.top+o.height/2,d=i.find(L=>{let b=L.getBoundingClientRect();return c>=b.left&&c<=b.right&&g>=b.top&&g<=b.bottom});if(!d)return;let f=parseInt((v=d.dataset.pageNumber)!=null?v:"1",10)-1,u=d.getBoundingClientRect(),w={x:(o.left-u.left)/u.width,y:(o.top-u.top)/u.height,w:o.width/u.width,h:o.height/u.height};h.has(f)||h.set(f,[]),(y=h.get(f))==null||y.push(w)}),h.size===0)return null;let n=Array.from(h.entries()).map(([o,c])=>({page:o,rects:c}));return{id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,color:e,isFlashcard:e==="flashcard",text:r.toString(),createdAt:new Date().toISOString(),pages:n}}scheduleRenderHighlights(){this.renderTimer&&window.clearTimeout(this.renderTimer),this.renderTimer=window.setTimeout(()=>{this.renderHighlights()},150)}async renderHighlights(){let r=this.findPdfViewer();if(!r)return;let t=this.getPdfFile();if(!t)return;let e=await this.plugin.loadHighlights(t.path);if(e.length===0)return;Array.from(r.querySelectorAll(".page")).forEach(a=>{var n;let i=a.querySelector(".study-assist-highlight-layer");i||(i=a.createDiv({cls:"study-assist-highlight-layer"})),i.empty();let h=parseInt((n=a.dataset.pageNumber)!=null?n:"1",10)-1;e.forEach(o=>{let c=o.pages.find(g=>g.page===h);c&&c.rects.forEach(g=>{let d=i.createDiv({cls:"study-assist-highlight"});d.style.left=`${g.x*100}%`,d.style.top=`${g.y*100}%`,d.style.width=`${g.w*100}%`,d.style.height=`${g.h*100}%`,d.style.background=D[o.color],o.isFlashcard&&d.addClass("flashcard")})})})}},k=class extends l.PluginSettingTab{constructor(r,t){super(r,t),this.plugin=t}display(){let{containerEl:r}=this;r.empty(),new l.Setting(r).setName("OpenAI API key").setDesc("Stored locally in your Obsidian settings.").addText(t=>t.setPlaceholder("sk-...").setValue(this.plugin.settings.apiKey).onChange(async e=>{this.plugin.settings.apiKey=e.trim(),await this.plugin.saveSettings()})),new l.Setting(r).setName("Model").setDesc("Default: gpt-5.1").addText(t=>t.setPlaceholder("gpt-5.1").setValue(this.plugin.settings.model).onChange(async e=>{this.plugin.settings.model=e.trim()||"gpt-5.1",await this.plugin.saveSettings()})),new l.Setting(r).setName("Storage folder").setDesc("Hidden folder for highlights, flashcards, and progress.").addText(t=>t.setPlaceholder(".flashcards").setValue(this.plugin.settings.storageFolder).onChange(async e=>{this.plugin.settings.storageFolder=e.trim()||".flashcards",await this.plugin.saveSettings()}))}},A=class extends l.Plugin{constructor(){super(...arguments);this.pdfControllers=new WeakMap}async onload(){await this.loadSettings(),this.addSettingTab(new k(this.app,this)),this.registerView(F,t=>new E(t,this)),this.registerView(P,t=>new T(t,this)),this.addCommand({id:"study-assist-generate-flashcards",name:"Generate flashcards from PDF flashcard highlights",callback:()=>void this.generateFlashcardsFromActivePdf()}),this.addCommand({id:"study-assist-open-flashcards",name:"Open flashcard study view",callback:()=>void this.openFlashcardView()}),this.addCommand({id:"study-assist-manage-flashcards",name:"Open flashcard manager",callback:()=>void this.openFlashcardManageView()}),this.addCommand({id:"study-assist-export-pdf-annotations",name:"Export current PDF annotations to markdown",callback:()=>void this.exportAnnotationsFromActivePdf()}),this.addRibbonIcon("sparkles","Generate Flashcards",()=>void this.generateFlashcardsFromActivePdf()),this.addRibbonIcon("dice-4","Flashcards",()=>void this.openFlashcardView()),this.registerEvent(this.app.workspace.on("active-leaf-change",t=>{t&&this.maybeAttachToPdfLeaf(t)})),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.app.workspace.iterateAllLeaves(t=>{this.maybeAttachToPdfLeaf(t)})})),this.app.workspace.iterateAllLeaves(t=>{this.maybeAttachToPdfLeaf(t)})}onunload(){this.pdfControllers=new WeakMap}maybeAttachToPdfLeaf(t){var i,h,n;if(((n=(h=(i=t.view).getViewType)==null?void 0:h.call(i))!=null?n:t.view.viewType)!=="pdf")return;let s=this.pdfControllers.get(t);if(s){s.ensureAttached();return}let a=new H(this,t);this.pdfControllers.set(t,a),a.init()}async loadSettings(){this.settings=Object.assign({},$,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async ensureStorageFolder(t){let e=this.settings.storageFolder||".flashcards",s=this.app.vault.adapter;return!await s.exists(e)&&t&&await s.mkdir(e),e}highlightPathFor(t){let e=this.hashString(t);return`${this.settings.storageFolder}/highlights-${e}.json`}flashcardPath(){return`${this.settings.storageFolder}/flashcards.json`}progressPath(){return`${this.settings.storageFolder}/progress.json`}async saveHighlight(t,e){await this.ensureStorageFolder(!0);let s=this.highlightPathFor(t),a=await this.readJson(s,{version:C,sourcePath:t,highlights:[]});a.sourcePath=t,a.highlights.push(e),await this.writeJson(s,a)}async loadHighlights(t){await this.ensureStorageFolder(!1);let e=this.highlightPathFor(t);return(await this.readJson(e,{version:C,sourcePath:t,highlights:[]})).highlights||[]}async loadAllCards(){await this.ensureStorageFolder(!1);let t=this.flashcardPath();return(await this.readJson(t,{version:x,cards:[]})).cards||[]}async addCards(t){await this.ensureStorageFolder(!0);let e=this.flashcardPath(),s=await this.readJson(e,{version:x,cards:[]});s.cards.push(...t),await this.writeJson(e,s)}async replaceAllCards(t){await this.ensureStorageFolder(!0);let e=this.flashcardPath(),s={version:x,cards:t};await this.writeJson(e,s),await this.pruneProgress(t)}async updateProgress(t,e){await this.updateProgressOptimistic(t,e)}async updateProgressOptimistic(t,e){var h;await this.ensureStorageFolder(!0);let s=this.progressPath(),a=(h=this.progressCache)!=null?h:await this.readJson(s,{version:m,progress:{}}),i=this.buildNextProgress(a.progress[t],e);return a.progress[t]=i,this.progressCache=a,this.writeJson(s,a),i}buildNextProgress(t,e){let s=new Date,a=t?{...t}:{streak:0,intervalDays:0};e?(a.streak+=1,a.intervalDays=Math.max(1,a.intervalDays+a.streak),a.done=!0):(a.streak=0,a.intervalDays=0,a.done=!1);let i=new Date(s.getTime());return i.setDate(s.getDate()+(e?a.intervalDays:0)),a.lastReviewedAt=s.toISOString(),a.nextDueAt=i.toISOString(),a}async loadProgress(){var e;await this.ensureStorageFolder(!1);let t=this.progressPath();return this.progressCache||(this.progressCache=await this.readJson(t,{version:m,progress:{}})),(e=this.progressCache.progress)!=null?e:{}}async resetProgress(){await this.ensureStorageFolder(!0);let t=this.progressPath(),e={version:m,progress:{}};await this.writeJson(t,e),this.progressCache=e}async removeProgress(t){var a;await this.ensureStorageFolder(!0);let e=this.progressPath(),s=(a=this.progressCache)!=null?a:await this.readJson(e,{version:m,progress:{}});delete s.progress[t],await this.writeJson(e,s),this.progressCache=s}async pruneProgress(t){var i;let e=new Set(t.map(h=>h.id)),s=this.progressPath(),a=(i=this.progressCache)!=null?i:await this.readJson(s,{version:m,progress:{}});Object.keys(a.progress).forEach(h=>{e.has(h)||delete a.progress[h]}),await this.writeJson(s,a),this.progressCache=a}async readJson(t,e){let s=this.app.vault.adapter;if(!await s.exists(t))return e;try{let i=await s.read(t);return Object.assign({},e,JSON.parse(i))}catch{return e}}async writeJson(t,e){await this.app.vault.adapter.write(t,JSON.stringify(e,null,2))}hashString(t){let e=2166136261;for(let s=0;s<t.length;s++)e^=t.charCodeAt(s),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24);return(e>>>0).toString(16)}getActivePdfFile(){var a,i,h,n,o;let t=this.app.workspace.getMostRecentLeaf();if(!t||((h=(i=(a=t.view).getViewType)==null?void 0:i.call(a))!=null?h:t.view.viewType)!=="pdf")return null;let s=t.view;return(s==null?void 0:s.file)instanceof l.TFile?s.file:(o=(n=t.view)==null?void 0:n.file)!=null?o:null}async generateFlashcardsFromActivePdf(){let t=this.getActivePdfFile();if(!t){new l.Notice("Open a PDF first.");return}if(!this.settings.apiKey){new l.Notice("Set your OpenAI API key in the plugin settings.");return}let s=(await this.loadHighlights(t.path)).filter(n=>n.isFlashcard&&!n.flashcardGenerated);if(s.length===0){new l.Notice("No new flashcard highlights found.");return}let a=s.map((n,o)=>`(${o+1}) ${n.text}`).join(`
`),i="You are a helpful assistant that turns study highlights into flashcards.",h=`Create concise flashcards from the following highlights. Return a JSON array where each item has 'question' and 'answer'. Avoid markdown, and keep questions short and clear.

`+a;try{let n=await this.callOpenAI(i,h),o=this.parseFlashcards(n);if(o.length===0){new l.Notice("No flashcards returned by the model.");return}let c=new Date().toISOString(),g=o.map(d=>({id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,sourcePath:t.path,highlightIds:s.map(f=>f.id),question:d.question,answer:d.answer,createdAt:c}));await this.addCards(g),await this.markHighlightsGenerated(t.path,s.map(d=>d.id)),new l.Notice(`Generated ${g.length} flashcards.`),await this.refreshFlashcardView(),await this.refreshFlashcardManageView()}catch(n){console.error(n),new l.Notice("Failed to generate flashcards.")}}async markHighlightsGenerated(t,e){await this.ensureStorageFolder(!0);let s=this.highlightPathFor(t),a=await this.readJson(s,{version:C,sourcePath:t,highlights:[]}),i=new Set(e);a.highlights=a.highlights.map(h=>i.has(h.id)?{...h,flashcardGenerated:!0}:h),await this.writeJson(s,a)}async callOpenAI(t,e){let s=await fetch("https://api.openai.com/v1/responses",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},body:JSON.stringify({model:this.settings.model||"gpt-5.1",instructions:t,input:e,temperature:.2})});if(!s.ok){let i=await s.text();throw new Error(`OpenAI API error: ${i}`)}let a=await s.json();return this.extractOutputText(a)}extractOutputText(t){if(t.output_text&&typeof t.output_text=="string")return t.output_text;if(Array.isArray(t.output)){for(let e of t.output)if((e==null?void 0:e.type)==="message"&&Array.isArray(e==null?void 0:e.content)){let s=e.content.find(a=>a.type==="output_text"||a.type==="text");if(s!=null&&s.text)return s.text}}return t!=null&&t.content&&typeof t.content=="string"?t.content:""}parseFlashcards(t){try{let e=JSON.parse(t);return Array.isArray(e)?e.filter(s=>(s==null?void 0:s.question)&&(s==null?void 0:s.answer)).map(s=>({question:String(s.question),answer:String(s.answer)})):[]}catch{return[]}}async openFlashcardView(){let t=this.app.workspace.getLeavesOfType(F)[0];t?this.app.workspace.revealLeaf(t):(t=this.app.workspace.getRightLeaf(!1),await t.setViewState({type:F,active:!0}))}async openFlashcardManageView(){let t=this.app.workspace.getLeavesOfType(P)[0];t?this.app.workspace.revealLeaf(t):(t=this.app.workspace.getRightLeaf(!1),await t.setViewState({type:P,active:!0}))}async refreshFlashcardView(){let t=this.app.workspace.getLeavesOfType(F);if(t.length!==0)for(let e of t){let s=e.view;s!=null&&s.refresh&&await s.refresh()}}async refreshFlashcardManageView(){let t=this.app.workspace.getLeavesOfType(P);if(t.length!==0)for(let e of t){let s=e.view;s!=null&&s.refresh&&await s.refresh()}}getAnnotationMarkdownPath(t){var a,i;let e=`${t.basename} Annotations.md`,s=(i=(a=t.parent)==null?void 0:a.path)!=null?i:"";return s?`${s}/${e}`:e}buildAnnotationMarkdown(t,e){let s=[];if(e.length===0)return s.push("_No annotations found._"),s.join(`
`);let a=["flashcard","yellow","green","blue"],i=new Map;e.forEach(n=>{var c;let o=(c=i.get(n.color))!=null?c:[];o.push(n),i.set(n.color,o)});let h=n=>n==="flashcard"?"Flashcard":n.charAt(0).toUpperCase()+n.slice(1);return a.forEach(n=>{let o=i.get(n);!o||o.length===0||(s.push(`## ${h(n)}`),o.forEach(c=>{let g=c.text.replace(/\s+/g," ").trim(),d=Array.from(new Set(c.pages.map(u=>u.page+1))).sort((u,w)=>u-w),f=d.length?` (pages ${d.join(", ")})`:"";s.push(`- ${g}${f}`)}),s.push(""))}),s.join(`
`).trimEnd()+`
`}async exportAnnotationsFromActivePdf(){let t=this.getActivePdfFile();if(!t)return;let e=await this.loadHighlights(t.path),s=this.buildAnnotationMarkdown(t,e),a=this.getAnnotationMarkdownPath(t),i=this.app.vault.getAbstractFileByPath(a);i instanceof l.TFile?await this.app.vault.modify(i,s):await this.app.vault.create(a,s)}};
