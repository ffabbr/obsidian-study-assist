var S=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var M=(p,r)=>{for(var e in r)S(p,e,{get:r[e],enumerable:!0})},I=(p,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of V(r))!R.call(p,s)&&s!==e&&S(p,s,{get:()=>r[s],enumerable:!(t=O(r,s))||t.enumerable});return p};var N=p=>I(S({},"__esModule",{value:!0}),p);var J={};M(J,{default:()=>A});module.exports=N(J);var l=require("obsidian"),$={apiKey:"",model:"gpt-5.1",storageFolder:".flashcards"},C=1,x=1,m=1,D={yellow:"#ffe066",green:"#b2f2bb",blue:"#a5d8ff",flashcard:"#ffb3c1"},F="gpt5-flashcards-view",P="gpt5-flashcards-manage",E=class extends l.ItemView{constructor(e,t){super(e);this.cards=[];this.index=0;this.showingAnswer=!1;this.progress={};this.plugin=t}getViewType(){return F}getDisplayText(){return"Flashcards"}async onOpen(){this.containerEl.empty(),this.containerEl.addClass("gpt5-flashcard-view"),await this.reload(),this.render()}async reload(){this.cards=await this.plugin.loadAllCards(),this.progress=await this.plugin.loadProgress(),this.index=0,this.showingAnswer=!1}async refresh(){await this.reload(),this.render()}async onClose(){this.containerEl.empty()}currentCard(){let e=this.remainingCards();return e.length===0?null:e[this.index%e.length]}async handleGrade(e){let t=this.currentCard();if(!t)return;await this.plugin.updateProgressOptimistic(t.id,e),this.progress=await this.plugin.loadProgress();let s=this.remainingCards();s.length>0?this.index=(this.index+1)%s.length:this.index=0,this.showingAnswer=!1,this.render()}remainingCards(){return this.cards.filter(e=>{var t;return!((t=this.progress[e.id])!=null&&t.done)})}render(){this.containerEl.empty();let e=this.currentCard(),t=this.containerEl.createDiv({cls:"gpt5-flashcard-card"}),s=this.containerEl.createDiv({cls:"gpt5-flashcard-controls"}),a=this.containerEl.createDiv({cls:"gpt5-flashcard-meta"});if(!e){if(this.cards.length===0){t.setText("No flashcards yet. Generate some from PDF highlights.");return}t.setText("Congrats! You finished all flashcards."),s.empty(),s.createEl("button",{text:"Restart"}).addEventListener("click",async()=>{await this.plugin.resetProgress(),await this.reload(),this.render()});return}t.setText(this.showingAnswer?e.answer:e.question),t.addEventListener("click",()=>{this.showingAnswer=!this.showingAnswer,this.render()});let i=s.createEl("button",{text:"Again"}),h=s.createEl("button",{text:"Good"});i.addEventListener("click",()=>void this.handleGrade(!1)),h.addEventListener("click",()=>void this.handleGrade(!0));let n=this.remainingCards().length;a.setText(`Remaining ${n} of ${this.cards.length}`)}},T=class extends l.ItemView{constructor(e,t){super(e);this.cards=[];this.plugin=t}getViewType(){return P}getDisplayText(){return"Flashcards Manager"}async onOpen(){this.containerEl.empty(),this.containerEl.addClass("gpt5-flashcard-manage"),await this.reload(),this.render()}async onClose(){this.containerEl.empty()}async reload(){this.cards=await this.plugin.loadAllCards()}async refresh(){await this.reload(),this.render()}render(){this.containerEl.empty(),this.containerEl.createDiv({cls:"gpt5-manage-header"}).createEl("h3",{text:"Flashcards"});let t=this.containerEl.createDiv({cls:"gpt5-manage-add"}),s=t.createEl("textarea");s.placeholder="Question";let a=t.createEl("textarea");a.placeholder="Answer",t.createEl("button",{text:"Add"}).addEventListener("click",async()=>{let n=s.value.trim(),o=a.value.trim();if(!n||!o)return;let c=new Date().toISOString(),d={id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,sourcePath:"manual",highlightIds:[],question:n,answer:o,createdAt:c};this.cards.unshift(d),await this.plugin.replaceAllCards(this.cards),s.value="",a.value="",this.render()});let h=this.containerEl.createDiv({cls:"gpt5-manage-list"});if(this.cards.length===0){h.setText("No flashcards yet.");return}this.cards.forEach((n,o)=>{let c=h.createDiv({cls:"gpt5-manage-row"}),d=c.createEl("textarea");d.value=n.question;let g=c.createEl("textarea");g.value=n.answer;let f=c.createDiv({cls:"gpt5-manage-actions"}),u=f.createEl("button",{text:"Save"}),w=f.createEl("button",{text:"Delete"});u.addEventListener("click",async()=>{let v=d.value.trim(),y=g.value.trim();!v||!y||(this.cards[o]={...n,question:v,answer:y},await this.plugin.replaceAllCards(this.cards))}),w.addEventListener("click",async()=>{this.cards.splice(o,1),await this.plugin.replaceAllCards(this.cards),await this.plugin.removeProgress(n.id),this.render()})})}},H=class{constructor(r,e){this.selectionHandlerAttached=!1;this.plugin=r,this.leaf=e}async init(){await this.ensureAttached()}destroy(){var r,e;(r=this.toolbar)==null||r.remove(),(e=this.observer)==null||e.disconnect(),this.retryTimer&&window.clearTimeout(this.retryTimer)}async ensureAttached(r=5){let e=this.leaf.view.containerEl;if(!e)return;(!this.toolbar||!e.contains(this.toolbar))&&(this.toolbar=e.createDiv({cls:"gpt5-pdf-toolbar"}),this.buildToolbar(this.toolbar));let t=this.findPdfViewer();if(!t){r>0&&(this.retryTimer=window.setTimeout(()=>{this.ensureAttached(r-1)},250));return}this.selectionHandlerAttached||(e.addEventListener("mouseup",s=>{let a=window.getSelection();!a||a.isCollapsed||a.anchorNode&&e.contains(a.anchorNode)&&s.preventDefault()}),this.selectionHandlerAttached=!0),this.observer&&this.attachedPdfViewer!==t&&(this.observer.disconnect(),this.observer=void 0,this.attachedPdfViewer=void 0),this.observer||(this.observer=new MutationObserver(()=>{this.scheduleRenderHighlights()}),this.observer.observe(t,{childList:!0,subtree:!0}),this.attachedPdfViewer=t),this.scheduleRenderHighlights()}buildToolbar(r){[{color:"yellow",label:"Yellow"},{color:"green",label:"Green"},{color:"blue",label:"Blue"},{color:"flashcard",label:"Flashcard"}].forEach(({color:t,label:s})=>{let a=r.createEl("button"),i=a.createSpan({cls:"gpt5-color-swatch"});i.style.background=D[t],a.createSpan({text:s}),a.addEventListener("click",async()=>{let h=window.getSelection();if(!h||h.isCollapsed){new l.Notice("Select text in the PDF first.");return}let n=this.findPdfViewer();if(!n){new l.Notice("PDF viewer not found.");return}let o=this.buildHighlightFromSelection(h,n,t);if(!o){new l.Notice("Could not capture selection.");return}let c=this.getPdfFile();if(!c){new l.Notice("No PDF file associated with this view.");return}await this.plugin.saveHighlight(c.path,o),h.removeAllRanges(),await this.renderHighlights()})})}findPdfViewer(){let r=this.leaf.view.containerEl;return r?r.querySelector(".pdf-viewer")||r.querySelector(".pdfViewer")||r.querySelector(".pdf-viewer-container"):null}getPdfFile(){var e,t,s;let r=this.leaf.view;return(r==null?void 0:r.file)instanceof l.TFile?r.file:(s=(t=(e=this.leaf)==null?void 0:e.view)==null?void 0:t.file)!=null?s:null}buildHighlightFromSelection(r,e,t){if(r.rangeCount===0)return null;let s=r.getRangeAt(0),a=Array.from(s.getClientRects()).filter(o=>o.width>1&&o.height>1);if(a.length===0)return null;let i=Array.from(e.querySelectorAll(".page"));if(i.length===0)return null;let h=new Map;if(a.forEach(o=>{var v,y;let c=o.left+o.width/2,d=o.top+o.height/2,g=i.find(L=>{let b=L.getBoundingClientRect();return c>=b.left&&c<=b.right&&d>=b.top&&d<=b.bottom});if(!g)return;let f=parseInt((v=g.dataset.pageNumber)!=null?v:"1",10)-1,u=g.getBoundingClientRect(),w={x:(o.left-u.left)/u.width,y:(o.top-u.top)/u.height,w:o.width/u.width,h:o.height/u.height};h.has(f)||h.set(f,[]),(y=h.get(f))==null||y.push(w)}),h.size===0)return null;let n=Array.from(h.entries()).map(([o,c])=>({page:o,rects:c}));return{id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,color:t,isFlashcard:t==="flashcard",text:r.toString(),createdAt:new Date().toISOString(),pages:n}}scheduleRenderHighlights(){this.renderTimer&&window.clearTimeout(this.renderTimer),this.renderTimer=window.setTimeout(()=>{this.renderHighlights()},150)}async renderHighlights(){let r=this.findPdfViewer();if(!r)return;let e=this.getPdfFile();if(!e)return;let t=await this.plugin.loadHighlights(e.path);if(t.length===0)return;Array.from(r.querySelectorAll(".page")).forEach(a=>{var n;let i=a.querySelector(".gpt5-highlight-layer");i||(i=a.createDiv({cls:"gpt5-highlight-layer"})),i.empty();let h=parseInt((n=a.dataset.pageNumber)!=null?n:"1",10)-1;t.forEach(o=>{let c=o.pages.find(d=>d.page===h);c&&c.rects.forEach(d=>{let g=i.createDiv({cls:"gpt5-highlight"});g.style.left=`${d.x*100}%`,g.style.top=`${d.y*100}%`,g.style.width=`${d.w*100}%`,g.style.height=`${d.h*100}%`,g.style.background=D[o.color],o.isFlashcard&&g.addClass("flashcard")})})})}},k=class extends l.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;r.empty(),new l.Setting(r).setName("OpenAI API key").setDesc("Stored locally in your Obsidian settings.").addText(e=>e.setPlaceholder("sk-...").setValue(this.plugin.settings.apiKey).onChange(async t=>{this.plugin.settings.apiKey=t.trim(),await this.plugin.saveSettings()})),new l.Setting(r).setName("Model").setDesc("Default: gpt-5.1").addText(e=>e.setPlaceholder("gpt-5.1").setValue(this.plugin.settings.model).onChange(async t=>{this.plugin.settings.model=t.trim()||"gpt-5.1",await this.plugin.saveSettings()})),new l.Setting(r).setName("Storage folder").setDesc("Hidden folder for highlights, flashcards, and progress.").addText(e=>e.setPlaceholder(".flashcards").setValue(this.plugin.settings.storageFolder).onChange(async t=>{this.plugin.settings.storageFolder=t.trim()||".flashcards",await this.plugin.saveSettings()}))}},A=class extends l.Plugin{constructor(){super(...arguments);this.pdfControllers=new WeakMap}async onload(){await this.loadSettings(),this.addSettingTab(new k(this.app,this)),this.registerView(F,e=>new E(e,this)),this.registerView(P,e=>new T(e,this)),this.addCommand({id:"gpt5-generate-flashcards",name:"Generate flashcards from PDF flashcard highlights",callback:()=>void this.generateFlashcardsFromActivePdf()}),this.addCommand({id:"gpt5-open-flashcards",name:"Open flashcard study view",callback:()=>void this.openFlashcardView()}),this.addCommand({id:"gpt5-manage-flashcards",name:"Open flashcard manager",callback:()=>void this.openFlashcardManageView()}),this.addCommand({id:"gpt5-export-pdf-annotations",name:"Export current PDF annotations to markdown",callback:()=>void this.exportAnnotationsFromActivePdf()}),this.addRibbonIcon("sparkles","Generate Flashcards",()=>void this.generateFlashcardsFromActivePdf()),this.addRibbonIcon("dice-4","Flashcards",()=>void this.openFlashcardView()),this.registerEvent(this.app.workspace.on("active-leaf-change",e=>{e&&this.maybeAttachToPdfLeaf(e)})),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.app.workspace.iterateAllLeaves(e=>{this.maybeAttachToPdfLeaf(e)})})),this.app.workspace.iterateAllLeaves(e=>{this.maybeAttachToPdfLeaf(e)})}onunload(){this.pdfControllers=new WeakMap}maybeAttachToPdfLeaf(e){var i,h,n;if(((n=(h=(i=e.view).getViewType)==null?void 0:h.call(i))!=null?n:e.view.viewType)!=="pdf")return;let s=this.pdfControllers.get(e);if(s){s.ensureAttached();return}let a=new H(this,e);this.pdfControllers.set(e,a),a.init()}async loadSettings(){this.settings=Object.assign({},$,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async ensureStorageFolder(e){let t=this.settings.storageFolder||".flashcards",s=this.app.vault.adapter;return!await s.exists(t)&&e&&await s.mkdir(t),t}highlightPathFor(e){let t=this.hashString(e);return`${this.settings.storageFolder}/highlights-${t}.json`}flashcardPath(){return`${this.settings.storageFolder}/flashcards.json`}progressPath(){return`${this.settings.storageFolder}/progress.json`}async saveHighlight(e,t){await this.ensureStorageFolder(!0);let s=this.highlightPathFor(e),a=await this.readJson(s,{version:C,sourcePath:e,highlights:[]});a.sourcePath=e,a.highlights.push(t),await this.writeJson(s,a)}async loadHighlights(e){await this.ensureStorageFolder(!1);let t=this.highlightPathFor(e);return(await this.readJson(t,{version:C,sourcePath:e,highlights:[]})).highlights||[]}async loadAllCards(){await this.ensureStorageFolder(!1);let e=this.flashcardPath();return(await this.readJson(e,{version:x,cards:[]})).cards||[]}async addCards(e){await this.ensureStorageFolder(!0);let t=this.flashcardPath(),s=await this.readJson(t,{version:x,cards:[]});s.cards.push(...e),await this.writeJson(t,s)}async replaceAllCards(e){await this.ensureStorageFolder(!0);let t=this.flashcardPath(),s={version:x,cards:e};await this.writeJson(t,s),await this.pruneProgress(e)}async updateProgress(e,t){await this.updateProgressOptimistic(e,t)}async updateProgressOptimistic(e,t){var h;await this.ensureStorageFolder(!0);let s=this.progressPath(),a=(h=this.progressCache)!=null?h:await this.readJson(s,{version:m,progress:{}}),i=this.buildNextProgress(a.progress[e],t);return a.progress[e]=i,this.progressCache=a,this.writeJson(s,a),i}buildNextProgress(e,t){let s=new Date,a=e?{...e}:{streak:0,intervalDays:0};t?(a.streak+=1,a.intervalDays=Math.max(1,a.intervalDays+a.streak),a.done=!0):(a.streak=0,a.intervalDays=0,a.done=!1);let i=new Date(s.getTime());return i.setDate(s.getDate()+(t?a.intervalDays:0)),a.lastReviewedAt=s.toISOString(),a.nextDueAt=i.toISOString(),a}async loadProgress(){var t;await this.ensureStorageFolder(!1);let e=this.progressPath();return this.progressCache||(this.progressCache=await this.readJson(e,{version:m,progress:{}})),(t=this.progressCache.progress)!=null?t:{}}async resetProgress(){await this.ensureStorageFolder(!0);let e=this.progressPath(),t={version:m,progress:{}};await this.writeJson(e,t),this.progressCache=t}async removeProgress(e){var a;await this.ensureStorageFolder(!0);let t=this.progressPath(),s=(a=this.progressCache)!=null?a:await this.readJson(t,{version:m,progress:{}});delete s.progress[e],await this.writeJson(t,s),this.progressCache=s}async pruneProgress(e){var i;let t=new Set(e.map(h=>h.id)),s=this.progressPath(),a=(i=this.progressCache)!=null?i:await this.readJson(s,{version:m,progress:{}});Object.keys(a.progress).forEach(h=>{t.has(h)||delete a.progress[h]}),await this.writeJson(s,a),this.progressCache=a}async readJson(e,t){let s=this.app.vault.adapter;if(!await s.exists(e))return t;try{let i=await s.read(e);return Object.assign({},t,JSON.parse(i))}catch{return t}}async writeJson(e,t){await this.app.vault.adapter.write(e,JSON.stringify(t,null,2))}hashString(e){let t=2166136261;for(let s=0;s<e.length;s++)t^=e.charCodeAt(s),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return(t>>>0).toString(16)}getActivePdfFile(){var a,i,h,n,o;let e=this.app.workspace.getMostRecentLeaf();if(!e||((h=(i=(a=e.view).getViewType)==null?void 0:i.call(a))!=null?h:e.view.viewType)!=="pdf")return null;let s=e.view;return(s==null?void 0:s.file)instanceof l.TFile?s.file:(o=(n=e.view)==null?void 0:n.file)!=null?o:null}async generateFlashcardsFromActivePdf(){let e=this.getActivePdfFile();if(!e){new l.Notice("Open a PDF first.");return}if(!this.settings.apiKey){new l.Notice("Set your OpenAI API key in the plugin settings.");return}let s=(await this.loadHighlights(e.path)).filter(n=>n.isFlashcard&&!n.flashcardGenerated);if(s.length===0){new l.Notice("No new flashcard highlights found.");return}let a=s.map((n,o)=>`(${o+1}) ${n.text}`).join(`
`),i="You are a helpful assistant that turns study highlights into flashcards.",h=`Create concise flashcards from the following highlights. Return a JSON array where each item has 'question' and 'answer'. Avoid markdown, and keep questions short and clear.

`+a;try{let n=await this.callOpenAI(i,h),o=this.parseFlashcards(n);if(o.length===0){new l.Notice("No flashcards returned by the model.");return}let c=new Date().toISOString(),d=o.map(g=>({id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,sourcePath:e.path,highlightIds:s.map(f=>f.id),question:g.question,answer:g.answer,createdAt:c}));await this.addCards(d),await this.markHighlightsGenerated(e.path,s.map(g=>g.id)),new l.Notice(`Generated ${d.length} flashcards.`),await this.refreshFlashcardView(),await this.refreshFlashcardManageView()}catch(n){console.error(n),new l.Notice("Failed to generate flashcards.")}}async markHighlightsGenerated(e,t){await this.ensureStorageFolder(!0);let s=this.highlightPathFor(e),a=await this.readJson(s,{version:C,sourcePath:e,highlights:[]}),i=new Set(t);a.highlights=a.highlights.map(h=>i.has(h.id)?{...h,flashcardGenerated:!0}:h),await this.writeJson(s,a)}async callOpenAI(e,t){let s=await fetch("https://api.openai.com/v1/responses",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},body:JSON.stringify({model:this.settings.model||"gpt-5.1",instructions:e,input:t,temperature:.2})});if(!s.ok){let i=await s.text();throw new Error(`OpenAI API error: ${i}`)}let a=await s.json();return this.extractOutputText(a)}extractOutputText(e){if(e.output_text&&typeof e.output_text=="string")return e.output_text;if(Array.isArray(e.output)){for(let t of e.output)if((t==null?void 0:t.type)==="message"&&Array.isArray(t==null?void 0:t.content)){let s=t.content.find(a=>a.type==="output_text"||a.type==="text");if(s!=null&&s.text)return s.text}}return e!=null&&e.content&&typeof e.content=="string"?e.content:""}parseFlashcards(e){try{let t=JSON.parse(e);return Array.isArray(t)?t.filter(s=>(s==null?void 0:s.question)&&(s==null?void 0:s.answer)).map(s=>({question:String(s.question),answer:String(s.answer)})):[]}catch{return[]}}async openFlashcardView(){let e=this.app.workspace.getLeavesOfType(F)[0];e?this.app.workspace.revealLeaf(e):(e=this.app.workspace.getRightLeaf(!1),await e.setViewState({type:F,active:!0}))}async openFlashcardManageView(){let e=this.app.workspace.getLeavesOfType(P)[0];e?this.app.workspace.revealLeaf(e):(e=this.app.workspace.getRightLeaf(!1),await e.setViewState({type:P,active:!0}))}async refreshFlashcardView(){let e=this.app.workspace.getLeavesOfType(F);if(e.length!==0)for(let t of e){let s=t.view;s!=null&&s.refresh&&await s.refresh()}}async refreshFlashcardManageView(){let e=this.app.workspace.getLeavesOfType(P);if(e.length!==0)for(let t of e){let s=t.view;s!=null&&s.refresh&&await s.refresh()}}getAnnotationMarkdownPath(e){var a,i;let t=`${e.basename} Annotations.md`,s=(i=(a=e.parent)==null?void 0:a.path)!=null?i:"";return s?`${s}/${t}`:t}buildAnnotationMarkdown(e,t){let s=[];if(t.length===0)return s.push("_No annotations found._"),s.join(`
`);let a=["flashcard","yellow","green","blue"],i=new Map;t.forEach(n=>{var c;let o=(c=i.get(n.color))!=null?c:[];o.push(n),i.set(n.color,o)});let h=n=>n==="flashcard"?"Flashcard":n.charAt(0).toUpperCase()+n.slice(1);return a.forEach(n=>{let o=i.get(n);!o||o.length===0||(s.push(`## ${h(n)}`),o.forEach(c=>{let d=c.text.replace(/\s+/g," ").trim(),g=Array.from(new Set(c.pages.map(u=>u.page+1))).sort((u,w)=>u-w),f=g.length?` (pages ${g.join(", ")})`:"";s.push(`- ${d}${f}`)}),s.push(""))}),s.join(`
`).trimEnd()+`
`}async exportAnnotationsFromActivePdf(){let e=this.getActivePdfFile();if(!e)return;let t=await this.loadHighlights(e.path),s=this.buildAnnotationMarkdown(e,t),a=this.getAnnotationMarkdownPath(e),i=this.app.vault.getAbstractFileByPath(a);i instanceof l.TFile?await this.app.vault.modify(i,s):await this.app.vault.create(a,s)}};
