var C=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var V=(p,a)=>{for(var t in a)C(p,t,{get:a[t],enumerable:!0})},M=(p,a,t,e)=>{if(a&&typeof a=="object"||typeof a=="function")for(let s of I(a))!R.call(p,s)&&s!==t&&C(p,s,{get:()=>a[s],enumerable:!(e=L(a,s))||e.enumerable});return p};var N=p=>M(C({},"__esModule",{value:!0}),p);var J={};V(J,{default:()=>x});module.exports=N(J);var l=require("obsidian"),$={apiKey:"",model:"gpt-5.1",storageFolder:".flashcards"},E=1,T=1,m=1,k={yellow:"#ffe066",green:"#b2f2bb",blue:"#a5d8ff",flashcard:"#ffb3c1"},P="study-assist-flashcards-view",F="study-assist-flashcards-manage",A=class extends l.ItemView{constructor(t,e){super(t);this.cards=[];this.index=0;this.showingAnswer=!1;this.progress={};this.plugin=e}getViewType(){return P}getDisplayText(){return"Flashcards"}async onOpen(){this.containerEl.empty(),this.containerEl.addClass("study-assist-flashcard-view"),await this.reload(),this.render()}async reload(){this.cards=await this.plugin.loadAllCards(),this.progress=await this.plugin.loadProgress(),this.index=0,this.showingAnswer=!1}async refresh(){await this.reload(),this.render()}onClose(){this.containerEl.empty()}currentCard(){let t=this.remainingCards();return t.length===0?null:t[this.index%t.length]}async handleGrade(t){let e=this.currentCard();if(!e)return;await this.plugin.updateProgressOptimistic(e.id,t),this.progress=await this.plugin.loadProgress();let s=this.remainingCards();s.length>0?this.index=(this.index+1)%s.length:this.index=0,this.showingAnswer=!1,this.render()}remainingCards(){return this.cards.filter(t=>{var e;return!((e=this.progress[t.id])!=null&&e.done)})}render(){this.containerEl.empty();let t=this.currentCard(),e=this.containerEl.createDiv({cls:"study-assist-flashcard-card"}),s=this.containerEl.createDiv({cls:"study-assist-flashcard-controls"}),r=this.containerEl.createDiv({cls:"study-assist-flashcard-meta"});if(!t){if(this.cards.length===0){e.setText("No flashcards yet. Generate some from PDF highlights.");return}e.setText("Congrats! You finished all flashcards."),s.empty(),s.createEl("button",{text:"Restart"}).addEventListener("click",()=>{(async()=>(await this.plugin.resetProgress(),await this.reload(),this.render()))()});return}e.setText(this.showingAnswer?t.answer:t.question),e.addEventListener("click",()=>{this.showingAnswer=!this.showingAnswer,this.render()});let i=s.createEl("button",{text:"Again"}),h=s.createEl("button",{text:"Good"});i.addEventListener("click",()=>void this.handleGrade(!1)),h.addEventListener("click",()=>void this.handleGrade(!0));let o=this.remainingCards().length;r.setText(`Remaining ${o} of ${this.cards.length}`)}},S=class extends l.ItemView{constructor(t,e){super(t);this.cards=[];this.plugin=e}getViewType(){return F}getDisplayText(){return"Flashcards manager"}async onOpen(){this.containerEl.empty(),this.containerEl.addClass("study-assist-flashcard-manage"),await this.reload(),this.render()}onClose(){this.containerEl.empty()}async reload(){this.cards=await this.plugin.loadAllCards()}async refresh(){await this.reload(),this.render()}render(){this.containerEl.empty(),this.containerEl.createDiv({cls:"study-assist-manage-header"}).createEl("h3",{text:"Flashcards"});let e=this.containerEl.createDiv({cls:"study-assist-manage-add"}),s=e.createEl("textarea");s.placeholder="Question";let r=e.createEl("textarea");r.placeholder="Answer",e.createEl("button",{text:"Add"}).addEventListener("click",()=>{(async()=>{let o=s.value.trim(),n=r.value.trim();if(!o||!n)return;let c=new Date().toISOString(),g={id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,sourcePath:"manual",highlightIds:[],question:o,answer:n,createdAt:c};this.cards.unshift(g),await this.plugin.replaceAllCards(this.cards),s.value="",r.value="",this.render()})()});let h=this.containerEl.createDiv({cls:"study-assist-manage-list"});if(this.cards.length===0){h.setText("No flashcards yet.");return}this.cards.forEach((o,n)=>{let c=h.createDiv({cls:"study-assist-manage-row"}),g=c.createEl("textarea");g.value=o.question;let d=c.createEl("textarea");d.value=o.answer;let f=c.createDiv({cls:"study-assist-manage-actions"}),u=f.createEl("button",{text:"Save"}),w=f.createEl("button",{text:"Delete"});u.addEventListener("click",()=>{(async()=>{let v=g.value.trim(),y=d.value.trim();!v||!y||(this.cards[n]={...o,question:v,answer:y},await this.plugin.replaceAllCards(this.cards))})()}),w.addEventListener("click",()=>{(async()=>(this.cards.splice(n,1),await this.plugin.replaceAllCards(this.cards),await this.plugin.removeProgress(o.id),this.render()))()})})}},H=class{constructor(a,t){this.selectionHandlerAttached=!1;this.plugin=a,this.leaf=t}init(){this.ensureAttached()}destroy(){var a,t;(a=this.toolbar)==null||a.remove(),(t=this.observer)==null||t.disconnect(),this.retryTimer&&window.clearTimeout(this.retryTimer)}ensureAttached(a=5){let t=this.leaf.view.containerEl;if(!t)return;(!this.toolbar||!t.contains(this.toolbar))&&(this.toolbar=t.createDiv({cls:"study-assist-pdf-toolbar"}),this.buildToolbar(this.toolbar));let e=this.findPdfViewer();if(!e){a>0&&(this.retryTimer=window.setTimeout(()=>{this.ensureAttached(a-1)},250));return}this.selectionHandlerAttached||(t.addEventListener("mouseup",s=>{let r=window.getSelection();!r||r.isCollapsed||r.anchorNode&&t.contains(r.anchorNode)&&s.preventDefault()}),this.selectionHandlerAttached=!0),this.observer&&this.attachedPdfViewer!==e&&(this.observer.disconnect(),this.observer=void 0,this.attachedPdfViewer=void 0),this.observer||(this.observer=new MutationObserver(()=>{this.scheduleRenderHighlights()}),this.observer.observe(e,{childList:!0,subtree:!0}),this.attachedPdfViewer=e),this.scheduleRenderHighlights()}buildToolbar(a){[{color:"yellow",label:"Yellow"},{color:"green",label:"Green"},{color:"blue",label:"Blue"},{color:"flashcard",label:"Flashcard"}].forEach(({color:e,label:s})=>{let r=a.createEl("button"),i=r.createSpan({cls:"study-assist-color-swatch"});i.style.background=k[e],r.createSpan({text:s}),r.addEventListener("click",()=>{(async()=>{let h=window.getSelection();if(!h||h.isCollapsed){new l.Notice("Select text in the PDF first.");return}let o=this.findPdfViewer();if(!o){new l.Notice("PDF viewer not found.");return}let n=this.buildHighlightFromSelection(h,o,e);if(!n){new l.Notice("Could not capture selection.");return}let c=this.getPdfFile();if(!c){new l.Notice("No PDF file associated with this view.");return}await this.plugin.saveHighlight(c.path,n),h.removeAllRanges(),await this.renderHighlights()})()})})}findPdfViewer(){var t,e;let a=this.leaf.view.containerEl;return a?(e=(t=a.querySelector(".pdf-viewer"))!=null?t:a.querySelector(".pdfViewer"))!=null?e:a.querySelector(".pdf-viewer-container"):null}getPdfFile(){let a=this.leaf.view;return a instanceof l.FileView&&a.file instanceof l.TFile?a.file:null}buildHighlightFromSelection(a,t,e){if(a.rangeCount===0)return null;let s=a.getRangeAt(0),r=Array.from(s.getClientRects()).filter(n=>n.width>1&&n.height>1);if(r.length===0)return null;let i=Array.from(t.querySelectorAll(".page"));if(i.length===0)return null;let h=new Map;if(r.forEach(n=>{var v,y;let c=n.left+n.width/2,g=n.top+n.height/2,d=i.find(O=>{let b=O.getBoundingClientRect();return c>=b.left&&c<=b.right&&g>=b.top&&g<=b.bottom});if(!d)return;let f=parseInt((v=d.dataset.pageNumber)!=null?v:"1",10)-1,u=d.getBoundingClientRect(),w={x:(n.left-u.left)/u.width,y:(n.top-u.top)/u.height,w:n.width/u.width,h:n.height/u.height};h.has(f)||h.set(f,[]),(y=h.get(f))==null||y.push(w)}),h.size===0)return null;let o=Array.from(h.entries()).map(([n,c])=>({page:n,rects:c}));return{id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,color:e,isFlashcard:e==="flashcard",text:a.toString(),createdAt:new Date().toISOString(),pages:o}}scheduleRenderHighlights(){this.renderTimer&&window.clearTimeout(this.renderTimer),this.renderTimer=window.setTimeout(()=>{this.renderHighlights()},150)}async renderHighlights(){let a=this.findPdfViewer();if(!a)return;let t=this.getPdfFile();if(!t)return;let e=await this.plugin.loadHighlights(t.path);if(e.length===0)return;Array.from(a.querySelectorAll(".page")).forEach(r=>{var o;let i=r.querySelector(".study-assist-highlight-layer");i||(i=r.createDiv({cls:"study-assist-highlight-layer"})),i.empty();let h=parseInt((o=r.dataset.pageNumber)!=null?o:"1",10)-1;e.forEach(n=>{let c=n.pages.find(g=>g.page===h);c&&c.rects.forEach(g=>{let d=i.createDiv({cls:"study-assist-highlight"});d.style.left=`${g.x*100}%`,d.style.top=`${g.y*100}%`,d.style.width=`${g.w*100}%`,d.style.height=`${g.h*100}%`,d.style.background=k[n.color],n.isFlashcard&&d.addClass("flashcard")})})})}},D=class extends l.PluginSettingTab{constructor(a,t){super(a,t),this.plugin=t}display(){let{containerEl:a}=this;a.empty(),new l.Setting(a).setName("Your OpenAI API key").setDesc("Stored locally in your Obsidian settings.").addText(t=>t.setPlaceholder("Example: sk-...").setValue(this.plugin.settings.apiKey).onChange(async e=>{this.plugin.settings.apiKey=e.trim(),await this.plugin.saveSettings()})),new l.Setting(a).setName("Model").setDesc("Default: gpt-5.1").addText(t=>t.setPlaceholder("Example: gpt-5.1").setValue(this.plugin.settings.model).onChange(async e=>{this.plugin.settings.model=e.trim()||"gpt-5.1",await this.plugin.saveSettings()})),new l.Setting(a).setName("Storage folder").setDesc("Hidden folder for highlights, flashcards, and progress.").addText(t=>t.setPlaceholder(".flashcards").setValue(this.plugin.settings.storageFolder).onChange(async e=>{this.plugin.settings.storageFolder=e.trim()||".flashcards",await this.plugin.saveSettings()}))}},x=class extends l.Plugin{constructor(){super(...arguments);this.pdfControllers=new WeakMap}async onload(){await this.loadSettings(),this.addSettingTab(new D(this.app,this)),this.registerView(P,t=>new A(t,this)),this.registerView(F,t=>new S(t,this)),this.addCommand({id:"generate-flashcards",name:"Generate flashcards from PDF flashcard highlights",callback:()=>void this.generateFlashcardsFromActivePdf()}),this.addCommand({id:"open-flashcards",name:"Open flashcard study view",callback:()=>void this.openFlashcardView()}),this.addCommand({id:"manage-flashcards",name:"Open flashcard manager",callback:()=>void this.openFlashcardManageView()}),this.addCommand({id:"export-pdf-annotations",name:"Export current PDF annotations to Markdown",callback:()=>void this.exportAnnotationsFromActivePdf()}),this.addRibbonIcon("sparkles","Generate flashcards",()=>void this.generateFlashcardsFromActivePdf()),this.addRibbonIcon("dice-4","Flashcards",()=>void this.openFlashcardView()),this.registerEvent(this.app.workspace.on("active-leaf-change",t=>{t&&this.maybeAttachToPdfLeaf(t)})),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.app.workspace.iterateAllLeaves(t=>{this.maybeAttachToPdfLeaf(t)})})),this.app.workspace.iterateAllLeaves(t=>{this.maybeAttachToPdfLeaf(t)})}onunload(){this.pdfControllers=new WeakMap}maybeAttachToPdfLeaf(t){if(this.app.isMobile||t.view.getViewType()!=="pdf")return;let s=this.pdfControllers.get(t);if(s){s.ensureAttached();return}let r=new H(this,t);this.pdfControllers.set(t,r),r.init()}async loadSettings(){this.settings=Object.assign({},$,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async ensureStorageFolder(t){let e=this.settings.storageFolder||".flashcards",s=this.app.vault.adapter;return!await s.exists(e)&&t&&await s.mkdir(e),e}highlightPathFor(t){let e=this.hashString(t);return`${this.settings.storageFolder}/highlights-${e}.json`}flashcardPath(){return`${this.settings.storageFolder}/flashcards.json`}progressPath(){return`${this.settings.storageFolder}/progress.json`}async saveHighlight(t,e){await this.ensureStorageFolder(!0);let s=this.highlightPathFor(t),r=await this.readJson(s,{version:E,sourcePath:t,highlights:[]});r.sourcePath=t,r.highlights.push(e),await this.writeJson(s,r)}async loadHighlights(t){await this.ensureStorageFolder(!1);let e=this.highlightPathFor(t);return(await this.readJson(e,{version:E,sourcePath:t,highlights:[]})).highlights||[]}async loadAllCards(){await this.ensureStorageFolder(!1);let t=this.flashcardPath();return(await this.readJson(t,{version:T,cards:[]})).cards||[]}async addCards(t){await this.ensureStorageFolder(!0);let e=this.flashcardPath(),s=await this.readJson(e,{version:T,cards:[]});s.cards.push(...t),await this.writeJson(e,s)}async replaceAllCards(t){await this.ensureStorageFolder(!0);let e=this.flashcardPath(),s={version:T,cards:t};await this.writeJson(e,s),await this.pruneProgress(t)}async updateProgress(t,e){await this.updateProgressOptimistic(t,e)}async updateProgressOptimistic(t,e){var h;await this.ensureStorageFolder(!0);let s=this.progressPath(),r=(h=this.progressCache)!=null?h:await this.readJson(s,{version:m,progress:{}}),i=this.buildNextProgress(r.progress[t],e);return r.progress[t]=i,this.progressCache=r,this.writeJson(s,r),i}buildNextProgress(t,e){let s=new Date,r=t?{...t}:{streak:0,intervalDays:0};e?(r.streak+=1,r.intervalDays=Math.max(1,r.intervalDays+r.streak),r.done=!0):(r.streak=0,r.intervalDays=0,r.done=!1);let i=new Date(s.getTime());return i.setDate(s.getDate()+(e?r.intervalDays:0)),r.lastReviewedAt=s.toISOString(),r.nextDueAt=i.toISOString(),r}async loadProgress(){var e;await this.ensureStorageFolder(!1);let t=this.progressPath();return this.progressCache||(this.progressCache=await this.readJson(t,{version:m,progress:{}})),(e=this.progressCache.progress)!=null?e:{}}async resetProgress(){await this.ensureStorageFolder(!0);let t=this.progressPath(),e={version:m,progress:{}};await this.writeJson(t,e),this.progressCache=e}async removeProgress(t){var r;await this.ensureStorageFolder(!0);let e=this.progressPath(),s=(r=this.progressCache)!=null?r:await this.readJson(e,{version:m,progress:{}});delete s.progress[t],await this.writeJson(e,s),this.progressCache=s}async pruneProgress(t){var i;let e=new Set(t.map(h=>h.id)),s=this.progressPath(),r=(i=this.progressCache)!=null?i:await this.readJson(s,{version:m,progress:{}});Object.keys(r.progress).forEach(h=>{e.has(h)||delete r.progress[h]}),await this.writeJson(s,r),this.progressCache=r}async readJson(t,e){let s=this.app.vault.adapter;if(!await s.exists(t))return e;try{let i=await s.read(t);return Object.assign({},e,JSON.parse(i))}catch{return e}}async writeJson(t,e){await this.app.vault.adapter.write(t,JSON.stringify(e,null,2))}hashString(t){let e=2166136261;for(let s=0;s<t.length;s++)e^=t.charCodeAt(s),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24);return(e>>>0).toString(16)}getActivePdfFile(){let t=this.app.workspace.getMostRecentLeaf();if(!t||t.view.getViewType()!=="pdf")return null;let s=t.view;return s instanceof l.FileView&&s.file instanceof l.TFile?s.file:null}async generateFlashcardsFromActivePdf(){let t=this.getActivePdfFile();if(!t){new l.Notice("Open a PDF first.");return}if(!this.settings.apiKey){new l.Notice("Set your OpenAI API key in the plugin settings first.");return}let s=(await this.loadHighlights(t.path)).filter(o=>o.isFlashcard&&!o.flashcardGenerated);if(s.length===0){new l.Notice("No new flashcard highlights found.");return}let r=s.map((o,n)=>`(${n+1}) ${o.text}`).join(`
`),i="You are a helpful assistant that turns study highlights into flashcards.",h=`Create concise flashcards from the following highlights. Return a JSON array where each item has 'question' and 'answer'. Avoid markdown, and keep questions short and clear.

`+r;try{let o=await this.callOpenAI(i,h),n=this.parseFlashcards(o);if(n.length===0){new l.Notice("No flashcards returned by the model.");return}let c=new Date().toISOString(),g=n.map(d=>({id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,sourcePath:t.path,highlightIds:s.map(f=>f.id),question:d.question,answer:d.answer,createdAt:c}));await this.addCards(g),await this.markHighlightsGenerated(t.path,s.map(d=>d.id)),new l.Notice(`Generated ${g.length} flashcards.`),await this.refreshFlashcardView(),await this.refreshFlashcardManageView()}catch(o){console.error(o),new l.Notice("Failed to generate flashcards.")}}async markHighlightsGenerated(t,e){await this.ensureStorageFolder(!0);let s=this.highlightPathFor(t),r=await this.readJson(s,{version:E,sourcePath:t,highlights:[]}),i=new Set(e);r.highlights=r.highlights.map(h=>i.has(h.id)?{...h,flashcardGenerated:!0}:h),await this.writeJson(s,r)}async callOpenAI(t,e){var i;let s=await(0,l.requestUrl)({url:"https://api.openai.com/v1/responses",method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},body:JSON.stringify({model:this.settings.model||"gpt-5.1",instructions:t,input:e,temperature:.2})});if(s.status<200||s.status>=300){let h=s.text||JSON.stringify((i=s.json)!=null?i:"");throw new Error(`OpenAI API error: ${h}`)}let r=s.json;return this.extractOutputText(r)}extractOutputText(t){if(t.output_text&&typeof t.output_text=="string")return t.output_text;if(Array.isArray(t.output)){for(let e of t.output)if((e==null?void 0:e.type)==="message"&&Array.isArray(e.content)){let s=e.content.find(r=>r.type==="output_text"||r.type==="text");if(s!=null&&s.text)return s.text}}return t!=null&&t.content&&typeof t.content=="string"?t.content:""}parseFlashcards(t){try{let e=JSON.parse(t);return Array.isArray(e)?e.filter(s=>(s==null?void 0:s.question)&&(s==null?void 0:s.answer)).map(s=>({question:String(s.question),answer:String(s.answer)})):[]}catch{return[]}}async openFlashcardView(){let t=this.app.workspace.getLeavesOfType(P)[0];t?await this.app.workspace.revealLeaf(t):(t=this.app.workspace.getRightLeaf(!1),await t.setViewState({type:P,active:!0}))}async openFlashcardManageView(){let t=this.app.workspace.getLeavesOfType(F)[0];t?await this.app.workspace.revealLeaf(t):(t=this.app.workspace.getRightLeaf(!1),await t.setViewState({type:F,active:!0}))}async refreshFlashcardView(){let t=this.app.workspace.getLeavesOfType(P);if(t.length!==0)for(let e of t){let s=e.view;s instanceof A&&await s.refresh()}}async refreshFlashcardManageView(){let t=this.app.workspace.getLeavesOfType(F);if(t.length!==0)for(let e of t){let s=e.view;s instanceof S&&await s.refresh()}}getAnnotationMarkdownPath(t){var r,i;let e=`${t.basename} Annotations.md`,s=(i=(r=t.parent)==null?void 0:r.path)!=null?i:"";return s?`${s}/${e}`:e}buildAnnotationMarkdown(t,e){let s=[];if(e.length===0)return s.push("_No annotations found._"),s.join(`
`);let r=["flashcard","yellow","green","blue"],i=new Map;e.forEach(o=>{var c;let n=(c=i.get(o.color))!=null?c:[];n.push(o),i.set(o.color,n)});let h=o=>o==="flashcard"?"Flashcard":o.charAt(0).toUpperCase()+o.slice(1);return r.forEach(o=>{let n=i.get(o);!n||n.length===0||(s.push(`## ${h(o)}`),n.forEach(c=>{let g=c.text.replace(/\s+/g," ").trim(),d=Array.from(new Set(c.pages.map(u=>u.page+1))).sort((u,w)=>u-w),f=d.length?` (pages ${d.join(", ")})`:"";s.push(`- ${g}${f}`)}),s.push(""))}),s.join(`
`).trimEnd()+`
`}async exportAnnotationsFromActivePdf(){let t=this.getActivePdfFile();if(!t)return;let e=await this.loadHighlights(t.path),s=this.buildAnnotationMarkdown(t,e),r=this.getAnnotationMarkdownPath(t),i=this.app.vault.getAbstractFileByPath(r);i instanceof l.TFile?await this.app.vault.modify(i,s):await this.app.vault.create(r,s)}};
